<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photos & Vid√©os du Mariage</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <!-- Bouton retour -->
        <div class="back-button-container">
            <button onclick="window.location.href='le-mariage.html'" class="back-button">‚Üê Retour</button>
        </div>

        <header>
            <h1 class="page-title">üì∏ Photos & Vid√©os</h1>
            <p class="page-subtitle">Partagez vos souvenirs du mariage</p>
        </header>

        <main>
            <!-- Section Upload -->
            <div class="upload-section">
                <h2>üì§ Partager vos m√©dias</h2>
                <div class="upload-form">
                    <div class="form-group">
                        <label for="userName">Votre pr√©nom</label>
                        <input type="text" id="userName" placeholder="Entrez votre pr√©nom" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="mediaFile">Choisir une photo ou vid√©o</label>
                        <input type="file" id="mediaFile" accept="image/*,video/*" required>
                        <small class="file-info">Formats accept√©s : Photos (JPG, PNG, HEIC...) et Vid√©os (MP4, MOV...). Max 100 MB</small>
                    </div>

                    <div class="form-group">
                        <label for="mediaDescription">Description (optionnelle)</label>
                        <textarea id="mediaDescription" placeholder="Ajoutez une l√©gende ou un commentaire..." rows="3"></textarea>
                    </div>

                    <div class="upload-progress-container" id="uploadProgressContainer" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <span class="progress-text" id="progressText">0%</span>
                    </div>

                    <button type="button" id="uploadBtn" class="confirm-button" onclick="uploadMedia()">
                        Envoyer
                    </button>
                </div>
            </div>

            <!-- Section Galerie -->
            <div class="gallery-section">
                <div class="gallery-header">
                    <h2>üñºÔ∏è Galerie partag√©e</h2>
                    <button id="refreshBtn" class="secondary-button" onclick="loadGallery()">üîÑ Actualiser</button>
                </div>
                
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterMedia('all')">Tous</button>
                    <button class="filter-btn" onclick="filterMedia('image')">Photos</button>
                    <button class="filter-btn" onclick="filterMedia('video')">Vid√©os</button>
                </div>

                <div id="galleryGrid" class="gallery-grid">
                    <div class="loading-message">Chargement de la galerie...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal pour afficher les m√©dias en grand -->
    <div id="mediaModal" class="modal">
        <div class="modal-content media-modal">
            <span class="close" onclick="closeMediaModal()">&times;</span>
            <div id="modalMediaContainer"></div>
            <div class="media-info">
                <p id="modalUserName"></p>
                <p id="modalDescription"></p>
                <p id="modalDate"></p>
                <button class="download-button" id="modalDownloadBtn">‚¨áÔ∏è T√©l√©charger</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration Firebase (m√™me config que script.js)
        const firebaseConfig = {
            apiKey: "AIzaSyBYhD-tfHQbL5bfWD7oTk3ODekSmfn5tf0",
            authDomain: "mariageej-22128.firebaseapp.com",
            projectId: "mariageej-22128",
            storageBucket: "mariageej-22128.firebasestorage.app",
            messagingSenderId: "951226680398",
            appId: "1:951226680398:web:85da933639c50066fe6f1f"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const db = firebase.firestore();

        let currentFilter = 'all';
        let allMedia = [];

        // Charger la galerie au chargement de la page
        window.addEventListener('DOMContentLoaded', () => {
            loadGallery();
        });

        // Upload m√©dia
        async function uploadMedia() {
            const userName = document.getElementById('userName').value.trim();
            const fileInput = document.getElementById('mediaFile');
            const description = document.getElementById('mediaDescription').value.trim();
            const uploadBtn = document.getElementById('uploadBtn');

            if (!userName) {
                alert('Veuillez entrer votre pr√©nom');
                return;
            }

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Veuillez s√©lectionner un fichier');
                return;
            }

            const file = fileInput.files[0];
            const maxSize = 100 * 1024 * 1024; // 100 MB

            if (file.size > maxSize) {
                alert('Le fichier est trop volumineux (max 100 MB)');
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Envoi en cours...';

            try {
                // Afficher la barre de progression
                document.getElementById('uploadProgressContainer').style.display = 'block';

                // Cr√©er une r√©f√©rence unique pour le fichier
                const timestamp = Date.now();
                const fileName = `${timestamp}_${file.name}`;
                const storageRef = storage.ref(`mariage-photos/${fileName}`);

                // Upload avec suivi de progression
                const uploadTask = storageRef.put(file);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        document.getElementById('progressFill').style.width = progress + '%';
                        document.getElementById('progressText').textContent = Math.round(progress) + '%';
                    },
                    (error) => {
                        console.error('Erreur upload:', error);
                        alert('Erreur lors de l\'envoi du fichier: ' + error.message);
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = 'Envoyer';
                        document.getElementById('uploadProgressContainer').style.display = 'none';
                    },
                    async () => {
                        // Upload termin√©, r√©cup√©rer l'URL
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();

                        // Sauvegarder les m√©tadonn√©es dans Firestore
                        await db.collection('mariage-media').add({
                            userName: userName,
                            description: description,
                            fileName: fileName,
                            fileUrl: downloadURL,
                            fileType: file.type,
                            fileSize: file.size,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            uploadDate: new Date().toISOString()
                        });

                        console.log('M√©dia upload√© avec succ√®s');
                        
                        // R√©initialiser le formulaire
                        document.getElementById('userName').value = '';
                        document.getElementById('mediaFile').value = '';
                        document.getElementById('mediaDescription').value = '';
                        document.getElementById('uploadProgressContainer').style.display = 'none';
                        
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = 'Envoyer';

                        alert('‚úÖ M√©dia partag√© avec succ√®s !');
                        
                        // Recharger la galerie
                        loadGallery();
                    }
                );

            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'envoi: ' + error.message);
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Envoyer';
                document.getElementById('uploadProgressContainer').style.display = 'none';
            }
        }

        // Charger la galerie
        async function loadGallery() {
            const galleryGrid = document.getElementById('galleryGrid');
            galleryGrid.innerHTML = '<div class="loading-message">Chargement...</div>';

            try {
                const snapshot = await db.collection('mariage-media')
                    .orderBy('timestamp', 'desc')
                    .get();

                allMedia = [];
                snapshot.forEach(doc => {
                    allMedia.push({ id: doc.id, ...doc.data() });
                });

                displayMedia(allMedia);

            } catch (error) {
                console.error('Erreur chargement galerie:', error);
                galleryGrid.innerHTML = '<div class="error-message">Erreur lors du chargement de la galerie. V√©rifiez que les r√®gles Firebase sont configur√©es.</div>';
            }
        }

        // Afficher les m√©dias
        function displayMedia(mediaList) {
            const galleryGrid = document.getElementById('galleryGrid');

            if (mediaList.length === 0) {
                galleryGrid.innerHTML = '<div class="empty-message">Aucune photo ou vid√©o partag√©e pour le moment. Soyez le premier ! üì∏</div>';
                return;
            }

            galleryGrid.innerHTML = '';

            mediaList.forEach(media => {
                const mediaCard = document.createElement('div');
                mediaCard.className = 'media-card';
                mediaCard.dataset.type = media.fileType.startsWith('image') ? 'image' : 'video';

                const isVideo = media.fileType.startsWith('video');

                if (isVideo) {
                    mediaCard.innerHTML = `
                        <div class="media-thumbnail video-thumbnail">
                            <video src="${media.fileUrl}" preload="metadata"></video>
                            <div class="video-overlay">‚ñ∂Ô∏è</div>
                        </div>
                        <div class="media-details">
                            <p class="media-user">üë§ ${media.userName}</p>
                            ${media.description ? `<p class="media-description">${media.description}</p>` : ''}
                        </div>
                    `;
                } else {
                    mediaCard.innerHTML = `
                        <div class="media-thumbnail">
                            <img src="${media.fileUrl}" alt="Photo de ${media.userName}" loading="lazy">
                        </div>
                        <div class="media-details">
                            <p class="media-user">üë§ ${media.userName}</p>
                            ${media.description ? `<p class="media-description">${media.description}</p>` : ''}
                        </div>
                    `;
                }

                mediaCard.onclick = () => openMediaModal(media);
                galleryGrid.appendChild(mediaCard);
            });
        }

        // Filtrer les m√©dias
        function filterMedia(type) {
            currentFilter = type;

            // Mettre √† jour les boutons actifs
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Filtrer et afficher
            let filteredMedia = allMedia;
            if (type === 'image') {
                filteredMedia = allMedia.filter(m => m.fileType.startsWith('image'));
            } else if (type === 'video') {
                filteredMedia = allMedia.filter(m => m.fileType.startsWith('video'));
            }

            displayMedia(filteredMedia);
        }

        // Ouvrir modal m√©dia
        function openMediaModal(media) {
            const modal = document.getElementById('mediaModal');
            const container = document.getElementById('modalMediaContainer');
            const isVideo = media.fileType.startsWith('video');

            if (isVideo) {
                container.innerHTML = `<video src="${media.fileUrl}" controls autoplay></video>`;
            } else {
                container.innerHTML = `<img src="${media.fileUrl}" alt="Photo de ${media.userName}">`;
            }

            document.getElementById('modalUserName').textContent = 'üë§ Partag√© par ' + media.userName;
            document.getElementById('modalDescription').textContent = media.description || '';
            
            const date = media.uploadDate ? new Date(media.uploadDate).toLocaleDateString('fr-FR', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : '';
            document.getElementById('modalDate').textContent = date;

            const downloadBtn = document.getElementById('modalDownloadBtn');
            downloadBtn.onclick = () => downloadMedia(media.fileUrl, media.fileName);

            modal.style.display = 'block';
        }

        // Fermer modal
        function closeMediaModal() {
            const modal = document.getElementById('mediaModal');
            modal.style.display = 'none';
            document.getElementById('modalMediaContainer').innerHTML = '';
        }

        // T√©l√©charger m√©dia
        async function downloadMedia(url, fileName) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error('Erreur t√©l√©chargement:', error);
                alert('Erreur lors du t√©l√©chargement. Vous pouvez faire un clic droit > Enregistrer sous sur le m√©dia.');
            }
        }

        // Fermer modal en cliquant en dehors
        window.onclick = function(event) {
            const modal = document.getElementById('mediaModal');
            if (event.target === modal) {
                closeMediaModal();
            }
        }
    </script>
</body>
</html>
